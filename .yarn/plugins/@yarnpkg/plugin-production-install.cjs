/* eslint-disable */
module.exports = {
name: "@yarnpkg/plugin-production-install",
factory: function (require) {
var plugin;plugin=(()=>{"use strict";var e={768:(e,t,r)=>{r.r(t),r.d(t,{default:()=>m});var o=r(688),s=r(966),a=r(594),i=r(318),n=r(827),c=r(42);async function p(e,t,r){return o.xfs.copyFilePromise(o.ppath.join(e,r),o.ppath.join(t,r))}async function l(e,t,r,s=[]){return async function e(t,r,s=[]){if(!(await o.xfs.lstatPromise(t)).isDirectory())throw new Error("src not a folder");{await o.xfs.existsPromise(r)||await o.xfs.mkdirpPromise(r);const a=await o.xfs.readdirPromise(t);for(const i of a){const a=o.ppath.join(t,i),n=o.ppath.join(r,i);(()=>{for(const e of s)if(a.endsWith(e))return!0;return!1})()||((await o.xfs.lstatPromise(a)).isDirectory()?await e(a,n,s):await o.xfs.copyFilePromise(a,n))}}}(o.ppath.join(e,r),o.ppath.join(t,r),s)}class u{constructor({multiFetcher:e,project:t,workspace:r,cache:o,outDirectoryPath:s,outConfiguration:a}){this.multiFetcher=e,this.project=t,this.workspace=r,this.cache=o,this.outDirectoryPath=s,this.outConfiguration=a}supports(e,t){return this.multiFetcher.supports(e,t)}getLocalPath(e,t){return e.reference.startsWith(s.WorkspaceResolver.protocol)&&e.reference!==s.WorkspaceResolver.protocol+"."?null:this.multiFetcher.getLocalPath(e,t)}async fetch(e,t){const r=t.checksums.get(e.locatorHash)||null;if(e.reference.startsWith(s.WorkspaceResolver.protocol)&&e.reference!==s.WorkspaceResolver.protocol+"."){const o=await this.makeTemporaryCache(t.cache),[a,i,n]=await o.fetchPackageFromCache(e,r,{onHit:()=>t.report.reportCacheHit(e),onMiss:()=>t.report.reportCacheMiss(e,s.structUtils.prettyLocator(t.project.configuration,e)+" can't be found in the cache and will be packed from disk."),loader:async()=>this.packWorkspace(e,t),skipIntegrityCheck:t.skipIntegrityCheck});return o.markedFiles.forEach(e=>t.cache.markedFiles.add(e)),{packageFs:a,releaseFs:i,prefixPath:s.structUtils.getIdentVendorPath(e),checksum:null!=r?r:n}}if(e.reference.startsWith("npm:")){const a=this.cache.getLocatorPath(e,r),i=t.cache.getLocatorPath(e,r);if(a&&await o.xfs.existsPromise(a)&&i&&!await o.xfs.existsPromise(i))try{await o.xfs.linkPromise(a,i)}catch(e){await o.xfs.existsPromise(i)||t.report.reportError(s.MessageName.FETCH_FAILED,e)}}return this.multiFetcher.fetch(e,t)}async packWorkspace(e,{report:t}){const r=this.project.getWorkspaceByLocator(e);if(await i.packUtils.hasPackScripts(r))try{const e=await s.Cache.find(r.project.configuration,{immutable:!0,check:!1});await r.project.install({report:t,cache:e})}catch(e){await r.project.resolveEverything({lockfileOnly:!0,report:t})}let o;return await i.packUtils.prepareForPack(r,{report:t},async()=>{t.reportJson({base:r.cwd});const e=await i.packUtils.genPackList(r);for(const r of e)t.reportInfo(null,r),t.reportJson({location:r});const a=await i.packUtils.genPackStream(r,e);o=await s.miscUtils.bufferStream(a)}),await s.tgzUtils.convertToZip(o,{stripComponents:1,prefixPath:s.structUtils.getIdentVendorPath(e)})}async makeTemporaryCache(e){const{configuration:{startingCwd:t,plugins:r},check:o,immutable:a,cwd:i}=e,n=s.Configuration.create(t,r);return n.useWithSource(t,{enableMirror:!1},t,{overwrite:!0}),new s.Cache(i,{configuration:n,check:o,immutable:a})}}class h{constructor({resolver:e,project:t}){this.resolver=e,this.project=t}supportsDescriptor(e,t){return this.resolver.supportsDescriptor(e,t)}supportsLocator(e,t){return this.resolver.supportsLocator(e,t)}shouldPersistResolution(e,t){return!e.reference.startsWith(s.WorkspaceResolver.protocol)&&this.resolver.shouldPersistResolution(e,t)}bindDescriptor(e,t,r){return this.resolver.bindDescriptor(e,t,r)}getResolutionDependencies(e,t){return this.resolver.getResolutionDependencies(e,t)}async getCandidates(e,t,r){if(e.range.startsWith(s.WorkspaceResolver.protocol)&&e.range!==s.WorkspaceResolver.protocol+"."){return[this.project.getWorkspaceByDescriptor(e).anchoredLocator]}return this.resolver.getCandidates(e,t,r)}async resolve(e,t){if(e.reference.startsWith(s.WorkspaceResolver.protocol)&&e.reference!==s.WorkspaceResolver.protocol+"."){const t=this.project.getWorkspaceByLocator(e);return{...e,version:t.manifest.version||"0.0.0",languageName:"unknown",linkType:s.LinkType.SOFT,dependencies:new Map([...t.manifest.dependencies]),peerDependencies:new Map([...t.manifest.peerDependencies]),dependenciesMeta:t.manifest.dependenciesMeta,peerDependenciesMeta:t.manifest.peerDependenciesMeta,bin:t.manifest.bin}}return this.resolver.resolve(e,t)}async getSatisfying(e,t,r){return null}}var d=function(e,t,r,o){var s,a=arguments.length,i=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var n=e.length-1;n>=0;n--)(s=e[n])&&(i=(a<3?s(i):a>3?s(t,r,i):s(t,r))||i);return a>3&&i&&Object.defineProperty(t,r,i),i};class f extends c.Command{constructor(){super(...arguments),this.json=!1,this.silent=!1}async execute(){const e=await s.Configuration.find(this.context.cwd,this.context.plugins),{project:t,workspace:r}=await s.Project.find(e,this.context.cwd);if(!r)throw new a.WorkspaceRequiredError(t.cwd,this.context.cwd);const i=await s.Cache.find(e,{immutable:!0,check:!1}),n=t.topLevelWorkspace.cwd,c=o.ppath.isAbsolute(this.outDirectory)?this.outDirectory:o.ppath.join(r.cwd,this.outDirectory);return(await s.StreamReport.start({configuration:e,json:this.json,stdout:this.context.stdout,includeLogs:!0},async d=>{await d.startTimerPromise("Setting up production directory",async()=>{await o.xfs.mkdirpPromise(c),await p(n,c,e.get("lockfileFilename")),await p(n,c,e.get("rcFilename")),await p(r.cwd,c,(0,o.toFilename)("package.json"));const t=[],s=r=>{try{e.get(r)&&t.push(e.get(r))}catch(e){}};s("bstatePath"),s("installStatePath"),s("cacheFolder"),s("pnpUnpluggedFolder"),s("deferredVersionFolder"),await l(n,c,".yarn",t)}),await d.startTimerPromise("Modifying to contain only production dependencies",async()=>{const e=o.ppath.join(c,(0,o.toFilename)("package.json")),t=o.ppath.join(n,(0,o.toFilename)("package.json")),r=await o.xfs.readJsonPromise(e),s=await o.xfs.readJsonPromise(t);r.devDependencies&&delete r.devDependencies,s.resolutions&&(r.resolutions=s.resolutions),await o.xfs.writeJsonPromise(e,r)}),await d.startTimerPromise("Installing production version",async()=>{const n=await s.Configuration.find(c,this.context.plugins),{project:p,workspace:l}=await s.Project.find(n,c);if(!l)throw new a.WorkspaceRequiredError(t.cwd,this.context.cwd);const f=await s.Cache.find(n,{immutable:!1,check:!1}),m=e.makeFetcher(),g=e.makeResolver(),w=new h({project:t,resolver:g}),k=new u({cache:i,multiFetcher:m,workspace:r,project:t,outConfiguration:n,outDirectoryPath:c});await p.install({cache:f,report:d,immutable:!1,fetcher:k,resolver:w}),await d.startTimerPromise("Cleaning up unused dependencies",async()=>{const e=this.cleanUpPatchSources(p,f);for(const t of e)d.reportInfo(s.MessageName.UNUSED_CACHE_ENTRY,o.ppath.basename(t)+" appears to be unused - removing"),o.xfs.removeSync(t)})})})).exitCode()}cleanUpPatchSources(e,t){const r=[];e.storedPackages.forEach(e=>{e.reference.startsWith("patch:")&&r.push(e)});const o=new Map;for(const e of r){const{sourceLocator:t}=n.patchUtils.parseLocator(e);o.set(t,e)}const s=[];return o.forEach((r,o)=>{var a;let i=!1;if(e.storedPackages.forEach(t=>{t.locatorHash!==r.locatorHash&&t.dependencies.forEach(t=>{e.storedResolutions.get(t.descriptorHash)===o.locatorHash&&(i=!0)})}),!i){const r=t.getLocatorPath(o,null!==(a=e.storedChecksums.get(o.locatorHash))&&void 0!==a?a:null);r&&s.push(r)}}),s}}f.usage=c.Command.Usage({description:"INSTALL!",details:"prod only install",examples:[["Install the project with only prod dependencies","$0 prod-install"]]}),d([c.Command.String()],f.prototype,"outDirectory",void 0),d([c.Command.Boolean("--json")],f.prototype,"json",void 0),d([c.Command.Boolean("--silent",{hidden:!0})],f.prototype,"silent",void 0),d([c.Command.Path("prod-install")],f.prototype,"execute",null);const m={commands:[f]}},594:e=>{e.exports=require("@yarnpkg/cli")},966:e=>{e.exports=require("@yarnpkg/core")},688:e=>{e.exports=require("@yarnpkg/fslib")},318:e=>{e.exports=require("@yarnpkg/plugin-pack")},827:e=>{e.exports=require("@yarnpkg/plugin-patch")},42:e=>{e.exports=require("clipanion")}},t={};function r(o){if(t[o])return t[o].exports;var s=t[o]={exports:{}};return e[o](s,s.exports,r),s.exports}return r.d=(e,t)=>{for(var o in t)r.o(t,o)&&!r.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r(768)})();
return plugin;
}
};