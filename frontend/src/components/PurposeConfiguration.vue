<!--
SPDX-FileCopyrightText: 2020 SAP SE or an SAP affiliate company and Gardener contributors

SPDX-License-Identifier: Apache-2.0
-->

<template>
  <action-button-dialog
    :shootItem="shootItem"
    :valid="valid"
    @dialogOpened="onConfigurationDialogOpened"
    ref="actionDialog"
    maxWidth="400"
    caption="Configure Purpose">
    <template v-slot:actionComponent>
      <purpose
        :secret="secret"
        @updatePurpose="onUpdatePurpose"
        @valid="onPurposeValid"
        ref="purpose"
        v-on="$purpose.hooks"
      ></purpose>
    </template>
  </action-button-dialog>
</template>

<script>
import { mapGetters } from 'vuex'
import find from 'lodash/find'

import ActionButtonDialog from '@/components/dialogs/ActionButtonDialog'

import { updateShootPurpose } from '@/utils/api'
import { errorDetailsFromError } from '@/utils/error'

import shootItem from '@/mixins/shootItem'
import asyncRef from '@/mixins/asyncRef'

const Purpose = () => import('@/components/Purpose')

export default {
  name: 'purpose-configuration',
  components: {
    ActionButtonDialog,
    Purpose
  },
  props: {
    shootItem: {
      type: Object
    }
  },
  mixins: [
    shootItem, asyncRef('purpose')
  ],
  data () {
    return {
      purpose: undefined,
      purposeValid: false
    }
  },
  computed: {
    ...mapGetters([
      'infrastructureSecretsByCloudProfileName'
    ]),
    valid () {
      return this.purposeValid
    },
    secret () {
      const secrets = this.infrastructureSecretsByCloudProfileName(this.shootCloudProfileName)
      const secret = find(secrets, ['metadata.name', this.shootSecretBindingName])
      if (!secret) {
        console.error('Secret must not be undefined')
      }
      return secret
    }
  },
  methods: {
    onPurposeValid (value) {
      this.purposeValid = value
    },
    onUpdatePurpose (purpose) {
      this.purpose = purpose
    },
    async onConfigurationDialogOpened () {
      await this.reset()
      const confirmed = await this.$refs.actionDialog.waitForDialogClosed()
      if (confirmed) {
        await this.updateConfiguration()
      }
    },
    async updateConfiguration () {
      try {
        await updateShootPurpose({
          namespace: this.shootNamespace,
          name: this.shootName,
          data: {
            purpose: this.purpose
          }
        })
      } catch (err) {
        const errorMessage = 'Could not update purpose'
        const errorDetails = errorDetailsFromError(err)
        const detailedErrorMessage = errorDetails.detailedMessage
        this.$refs.actionDialog.setError({ errorMessage, detailedErrorMessage })
        console.error(this.errorMessage, errorDetails.errorCode, errorDetails.detailedMessage, err)
      }
    },
    async reset () {
      this.purpose = this.shootPurpose
      await this.$purpose.dispatch('setPurpose', this.purpose)
    }
  }
}
</script>
